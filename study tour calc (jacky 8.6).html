<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>STUDY TOUR ‚Äî Cost Calculator (Jacky 8.6)</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --brand:#5b46c6; --ink:#1f2340; --muted:#8287a1; --line:#e8eaf6;
  --w-cat:170px; --w-sub:200px; --w-item:260px; --w-qty:92px; --w-unit:120px; --w-meas:180px; --w-total:140px;
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:1180px;margin:34px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 28px rgba(28,30,64,.08)}
h1{margin:0;padding:16px 20px;border-bottom:1px solid var(--line);font-size:18px}
.badge{display:inline-block;margin-left:8px;background:#efeaff;color:#4a31b8;border:1px solid #e0d8ff;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--line)}
.topbar .left{display:flex;gap:10px;align-items:center}
button{height:36px;padding:0 14px;border-radius:999px;border:1px solid var(--brand);cursor:pointer;font-weight:600}
button.primary{background:var(--brand);color:#fff}
button.ghost{background:#fff;color:var(--brand)}
button.xbtn{border-color:#e8eaf6;background:#fff;color:#9aa0bd;width:28px;height:28px;border-radius:50%}
button.xbtn:hover{background:#fff2f2;border-color:#ffdcdc;color:#c54a4a}

/* Calculator view */
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:14px 20px}
.grid label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
.span-4{grid-column:1 / -1}

input[type="text"],input[type="number"],input[type="date"],select{width:100%;height:36px;border:1px solid #e1e4f1;border-radius:8px;background:#fff;padding:0 10px}
input[type="number"]{text-align:right}

.tablewrap{padding:8px 20px}
table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
thead th{background:var(--brand);color:#fff;padding:10px 8px;font-weight:700;letter-spacing:.02em}
thead th:first-child{border-top-left-radius:10px}
thead th:last-child{border-top-right-radius:10px}
tbody td{background:#fff;border-bottom:1px solid var(--line);padding:8px;vertical-align:middle}
tfoot td{background:#fff;padding:12px}
td.cat{width:var(--w-cat)} td.sub{width:var(--w-sub)} td.item{width:var(--w-item)}
td.qty{width:var(--w-qty)} td.unit{width:var(--w-unit)} td.meas{width:var(--w-meas)}
td.total{min-width:120px;text-align:right;font-variant-numeric:tabular-nums}
td.meas{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
td.remove{width:48px;text-align:center}
#costTable th,#costTable td{min-width:0}
#costTable select,#costTable input{width:100%;min-width:0}
#costTable td.qty input,#costTable td.unit input{text-align:right}
.actions{display:flex;gap:10px}

/* Summary Box (clean aligned) */
.summary-box{padding:0 20px 18px}
.summary{
  width:var(--w-total);margin-left:auto;
  background:#fff;border:1px solid #e8e8ee;border-radius:8px;padding:10px 12px;box-shadow:0 1px 2px rgba(0,0,0,.04);
  margin-bottom:12px;
}
.summary .line{display:flex;justify-content:space-between;gap:12px;margin:6px 0;font-variant-numeric:tabular-nums}
.summary .label{color:#6f6f81;font-size:12px}
.summary .final{font-weight:800;border-top:1px dashed #e2e2ee;padding-top:8px;margin-top:6px}
.tiny{display:block;color:#8c8c9a;font-size:11px;line-height:1.35}
.help{padding:0 20px 20px;color:#69708f;font-size:12px}
.muted{color:#9aa0bd}

/* Pricing Manager view */
#pricingManagerView{display:none}
.pm-head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--line)}
.pm-filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pm-actions{display:flex;gap:10px;align-items:center}
.pm-filters select,.pm-filters input{height:36px;border:1px solid #e1e4f1;border-radius:8px;padding:0 10px}

.pm-wrap{padding:12px 20px 20px}
.pm-table{width:100%;border-collapse:separate;border-spacing:0}
.pm-table thead th{background:#efeaff;color:#3c2fb5;padding:8px 10px;text-align:left}
.pm-table tbody td{background:#fff;border-bottom:1px solid #eee;padding:8px 10px;vertical-align:middle}
.pm-table input[type="number"], .pm-table select{width:100%;height:32px;border:1px solid #e1e4f1;border-radius:8px;padding:0 8px}
.pm-sticky{position:sticky;bottom:0;background:#faf9ff;border-top:1px solid #e7e3ff;padding:10px 20px;display:flex;gap:8px;justify-content:flex-end}
.pm-note{padding:8px 20px;color:#6c6e86;font-size:12px}

/* Modal (Add Item & Aviation Tiers reuse same style) */
.modal-bg{
  position:fixed;inset:0;background:rgba(18,18,28,.42);display:none;align-items:center;justify-content:center;z-index:9990;
}
.modal{
  width:min(640px,92vw);background:#fff;border-radius:14px;border:1px solid #e6e6f3;box-shadow:0 20px 60px rgba(30,33,70,.25);overflow:hidden;
}
.modal header{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.modal h3{margin:0;font-size:16px}
.modal .body{padding:16px}
.modal .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
.modal label{display:block;color:#63698c;font-size:12px;margin-bottom:6px}
.modal input,.modal select{width:100%;height:36px;border:1px solid #e1e4f1;border-radius:8px;padding:0 10px}
.modal footer{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}

/* Toast */
.toast{
  position:fixed;right:20px;bottom:20px;z-index:9999;
  background:#1f8b4c;color:#fff;border-radius:10px;padding:10px 14px;
  box-shadow:0 6px 20px rgba(0,0,0,.12);opacity:0;transform:translateY(8px);transition:all .25s ease;
  font-weight:600
}
.toast.show{opacity:1;transform:translateY(0)}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <div class="topbar">
      <div class="left">
        <h1 style="border:0;padding:0;margin:0;">STUDY TOUR ‚Äî Cost Calculator <span class="badge">Jacky 8.6</span></h1>
      </div>
      <div class="right">
        <button id="toPricing" class="ghost">‚öô Edit Pricing</button>
        <button id="toCalc" class="ghost" style="display:none">‚Üê Back to Calculator</button>
      </div>
    </div>

    <!-- CALCULATOR VIEW -->
    <section id="calculatorView">
      <div class="grid">
        <!-- Row 1 -->
        <div><label>Student Group Name</label><input id="studentGroupName" type="text" placeholder="e.g. Sunshine High"></div>
        <div><label>Student Group</label><input id="studentGroup" type="text" placeholder="e.g. Year 9‚Äì10"></div>
        <div><label>Number of Students</label><input id="numStudents" type="number" min="0" value="20"></div>
        <div><label>Date</label><input id="tripDate" type="date"></div>
        <!-- Row 2 -->
        <div><label>Weeks</label><input id="weeks" type="number" min="1" value="1"></div>
        <div><label>Time (hrs)</label><input id="timehrs" type="number" min="0" step="0.5" value="0"></div>
        <div><label>Profit Margin (%)</label><input id="profitMargin" type="number" min="0" value="20"></div>
        <div><label>Agent Commission (%)</label><input id="agentCommission" type="number" min="0" value="0"></div>
        <!-- Row 3 -->
        <div class="span-4"><label>Notes</label><input id="notes" type="text" placeholder=""></div>
      </div>

      <div class="tablewrap">
        <table id="costTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Subcategory</th>
              <th>Item</th>
              <th>Qty</th>
              <th>Unit $</th>
              <th>Measure</th>
              <th>Total $</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="costItems"><!-- empty on load --></tbody>
          <tfoot>
            <tr>
              <td colspan="8">
                <div class="actions">
                  <button id="addRowBtn" class="primary">+ Add Cost Item</button>
                  <button id="csvBtn" class="ghost">Export Table</button>
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="summary-box">
        <div class="summary">
  <div class="line"><span class="label">Base</span><span id="baseVal">$0.00</span></div>

  <!-- ‚úÖ Bold Profit -->
  <div class="line bold"><span class="label">Profit</span><span id="profitVal">$0.00</span></div>

  <div class="line"><span class="label">Final</span><span id="finalVal">$0.00</span></div>

  <!-- ‚úÖ Bold Price / Student -->
  <div class="line bold"><span class="label">Price / Student</span><span id="ppsVal">$0.00</span></div>

  <div class="summary-line">
    <span>Price / Student (commission included):</span>
    <span id="ppsCommVal">$0.00</span>
  </div>
</div>

        <small class="tiny">Per-day uses 5 school days per week. <b>Cookery</b> auto-qty = students + 1. <b>Aviation</b> uses tiered fixed group pricing. Qty typing overrides auto logic.</small>
      </div>

      <div class="help">Profit excludes <b>Application Fee</b>, <b>Learning Materials</b>, and <b>Accommodation</b>.</div>
    </section>

    <!-- PRICING MANAGER VIEW -->
    <section id="pricingManagerView">
      <div class="pm-head">
        <div class="pm-filters">
          <select id="pmCategoryFilter">
            <option value="">All Categories</option>
          </select>
          <input id="pmSearch" type="text" placeholder="Search item‚Ä¶"/>
        </div>
        <div class="pm-actions">
          <button id="pmExport" class="ghost">üì§ Export Pricing JSON</button>
          <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;">
            üì• Import JSON
            <input id="pmImport" type="file" accept="application/json" style="display:none">
          </label>
          <button id="pmAviBtn" class="ghost">‚úà Edit Aviation Class </button>
          <button id="pmAddBtn" class="primary">‚ûï Add New Item</button>
        </div>
      </div>

      <div class="pm-wrap">
        <table class="pm-table" id="pmTable">
          <thead>
            <tr>
              <th style="width:180px">Category</th>
              <th style="width:200px">Subcategory</th>
              <th>Item</th>
              <th style="width:140px">Price ($)</th>
              <th style="width:220px">Measurement</th>
            </tr>
          </thead>
          <tbody><!-- rows injected --></tbody>
        </table>
        <div class="pm-note">Changes are <b>auto-saved</b>. A green toast confirms each update.</div>
      </div>

      <div class="pm-sticky">
        <span style="margin-right:auto;color:#6c6e86;font-size:12px">Tip: Export JSON to keep a backup of your pricing & measurements.</span>
        <button id="toCalcBottom" class="ghost">‚Üê Back to Calculator</button>
      </div>
    </section>

  </div>
</div>

<!-- Add Item Modal -->
<div id="addModalBg" class="modal-bg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
    <header>
      <h3 id="addModalTitle">‚ûï Create New Item</h3>
      <button id="addClose" class="xbtn" aria-label="Close">√ó</button>
    </header>
    <div class="body">
      <div class="row">
        <div>
          <label>Category</label>
          <select id="addCat"></select>
        </div>
        <div>
          <label>Subcategory</label>
          <select id="addSub"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Item Name</label>
          <input id="addName" type="text" placeholder="e.g. Museum Admission"/>
        </div>
        <div>
          <label>Default Price ($)</label>
          <input id="addPrice" type="number" step="0.01" min="0" value="0"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Measurement</label>
          <select id="addMeasure"></select>
        </div>
        <div>
          <label style="visibility:hidden">.</label>
          <div class="muted" style="padding:8px 6px">Aviation stays tiered. Transport is usually <b>per bus</b>.</div>
        </div>
      </div>
      <div class="muted" id="addError" style="color:#c0392b;margin-top:4px;display:none"></div>
    </div>
    <footer>
      <button id="addCancel" class="ghost">Cancel</button>
      <button id="addSave" class="primary">Save Item</button>
    </footer>
  </div>
</div>

<!-- Aviation Tiers Modal -->
<div id="aviModalBg" class="modal-bg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aviModalTitle">
    <header>
      <h3 id="aviModalTitle">‚úà Edit Aviation Class </h3>
      <button id="aviClose" class="xbtn" aria-label="Close">√ó</button>
    </header>
    <div class="body">
      <div class="muted" style="margin-bottom:8px">
        Configure fixed group pricing by student count. The last row controls pricing for groups > 35.
      </div>
      <table class="pm-table" style="width:100%">
        <thead>
          <tr>
            <th style="width:160px">Min Students</th>
            <th style="width:160px">Max Students</th>
            <th>Fixed Price ($)</th>
          </tr>
        </thead>
        <tbody id="aviTierBody"><!-- rows injected --></tbody>
      </table>

      <div style="margin-top:14px;border-top:1px solid #eee;padding-top:12px">
        <div class="muted" style="margin-bottom:8px"><b>Overflow (> 35 students)</b></div>
        <div class="row">
          <div>
            <label>Base Price ($)</label>
            <input id="aviBase" type="number" step="1" min="0" value="7300"/>
          </div>
          <div>
            <label>Extra per student over</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="aviExtraPer" type="number" step="1" min="0" value="230" placeholder="Amount $"/>
              <input id="aviExtraStart" type="number" step="1" min="0" value="35" placeholder="Threshold"/>
            </div>
          </div>
        </div>
      </div>
      <div id="aviErr" class="muted" style="color:#c0392b;margin-top:6px;display:none"></div>
    </div>
    <footer>
      <button id="aviCancel" class="ghost">Cancel</button>
      <button id="aviSave" class="primary">Save Tiers</button>
    </footer>
  </div>
</div>

<script>

/* =========================
   DATA: Catalog + Measurements + Prices (Jacky 8.5)
========================= */
const catalog = {
  "Application Fee": { "-": ["Application Fee"] },
  "Labour": {
    "-": [
      "Trainer Cost - Business Days",
      "Trainer Cost - Weekend (20% Levy)",
      "Administrative Cost - Business Days",
      "Administrative Cost - Weekend (20% Levy)",
      "Media Team Cost ‚Äì Business Days"
    ]
  },
  "Learning Materials": {
    "-": [
      "Health Care (Equipment Usage)",
      "Cookery (Cooking Materials)",
      "ELICOS (Printing Material)",
      "First Aid"
    ]
  },
  "Accommodation": {
    "Homestay": [
      "Placement Fee",
      "Homestay Twin",
      "Homestay Single",
      "Escort Homestay Fee",
      "Dietary Requirements",
      "Pick-up & drop-off service"
    ],
    "Student Accommodation": [
      "Full Year 2025 Studio",
      "Semester One 2025 Studio",
      "Semester Two 2025 Studio",
      "Short Stay Studio"
    ]
  },
  "Activity": {
    "University Campus Tour": [
      "University Campus Tour - Half Day (15-20)",
      "University Campus Tour - Half Day (21-30)",
      "University Campus Tour - Half Day (31-39)",
      "University Campus Tour - Half Day (40+)",
      "University Campus Tour - Full Day (15-20)",
      "University Campus Tour - Full Day (21-30)",
      "University Campus Tour - Full Day (31-39)",
      "University Campus Tour - Full Day (40+)"
    ],
    "University Campus Tour + Science Lab Visit": [
      "University Campus Tour + Science Lab Visit - Half Day (15-20)",
      "University Campus Tour + Science Lab Visit - Half Day (21-30)",
      "University Campus Tour + Science Lab Visit - Half Day (31-39)",
      "University Campus Tour + Science Lab Visit - Half Day (40+)",
      "University Campus Tour + Science Lab Visit - Full Day (15-20)",
      "University Campus Tour + Science Lab Visit - Full Day (21-30)",
      "University Campus Tour + Science Lab Visit - Full Day (31-39)",
      "University Campus Tour + Science Lab Visit - Full Day (40+)"
    ],
    "Other Activity": [
      "Day Tour in Brisbane",
      "Local School Immersion",
      "Day Tour to Gold Coast with Theme Park Visit",
      "Aviation Class",
      "Stradbroke Island Day Tour - 10 seat mini bus",
      "Stradbroke Island Day Tour - 21/24 seat mini bus",
      "Stradbroke Island Day Tour - 39 seat midi coach",
      "Stradbroke Island Day Tour - 57 seat coach",
      "Stradbroke Island Day Tour - 61 seat coach",
      "Other Activities"
    ]
  },
  "Transport": {
    "Airport Transfer": [
      "BNE Airport to City, or return - Single Pax",
      "BNE Airport to City, or return - 10 seat mini bus",
      "BNE Airport to City, or return - 21/24 seat mini bus",
      "BNE Airport to City, or return - 39 seat midi coach",
      "BNE Airport to City, or return - 57 seat coach",
      "BNE Airport to City, or return - 61 seat coach"
    ],
    "8hr Tour Local": [
      "8hr Tour Local - 10 seat mini bus",
      "8hr Tour Local - 21/24 seat mini bus",
      "8hr Tour Local - 39 seat midi coach",
      "8hr Tour Local - 57 seat coach",
      "8hr Tour Local - 61 seat coach"
    ],
    "8hr Tour Over 100km": [
      "8hr Tour Over 100km - 10 seat mini bus",
      "8hr Tour Over 100km - 21/24 seat mini bus",
      "8hr Tour Over 100km - 39 seat midi coach",
      "8hr Tour Over 100km - 57 seat coach",
      "8hr Tour Over 100km - 61 seat coach"
    ],
    "Theme Park Transfers": [
      "Theme Park Transfers - 10 seat mini bus",
      "Theme Park Transfers - 21/24 seat mini bus",
      "Theme Park Transfers - 39 seat midi coach",
      "Theme Park Transfers - 57 seat coach",
      "Theme Park Transfers - 61 seat coach"
    ],
    "Australia Zoo Transfer": [
      "Australia Zoo - 10 seat mini bus",
      "Australia Zoo - 21/24 seat mini bus",
      "Australia Zoo - 39 seat midi coach",
      "Australia Zoo - 57 seat coach",
      "Australia Zoo - 61 seat coach"
    ]
  }
};

/* Measurement Logic */
const itemMeta = {
  "Application Fee": { unit:"per_student_once", measure:"per student (once)" },

  "Trainer Cost - Business Days": { unit:"per_week", measure:"per week" },
  "Trainer Cost - Weekend (20% Levy)": { unit:"per_hour", measure:"per hour" },
  "Administrative Cost - Business Days": { unit:"per_hour", measure:"per hour" },
  "Administrative Cost - Weekend (20% Levy)": { unit:"per_hour", measure:"per hour" },
  "Media Team Cost ‚Äì Business Days": { unit:"per_hour", measure:"per hour" },

  "Health Care (Equipment Usage)": { unit:"per_student", measure:"per student" },
  "Cookery (Cooking Materials)": { unit:"per_student_day", measure:"per student / day", cookery:true },
  "ELICOS (Printing Material)": { unit:"per_student_week", measure:"per student / week" },
  "First Aid": { unit:"per_student", measure:"per student" },

  "Placement Fee": { unit:"per_student_once", measure:"per student (Escot included)" },
  "Homestay Twin": { unit:"per_student_week", measure:"per student / week" },
  "Homestay Single": { unit:"per_student_week", measure:"per student / week" },
  "Escort Homestay Fee": { unit:"per_student_week", measure:"per student / week" },
  "Dietary Requirements": { unit:"per_student_week", measure:"per student / week" },
  "Pick-up & drop-off service": { unit:"per_student_week", measure:"per student / week (5 days)" },

  "Full Year 2025 Studio": { unit:"per_student_week", measure:"per person / week" },
  "Semester One 2025 Studio": { unit:"per_student_week", measure:"per person / week" },
  "Semester Two 2025 Studio": { unit:"per_student_week", measure:"per person / week" },
  "Short Stay Studio": { unit:"per_student_week", measure:"per person / week" },

  "University Campus Tour - Half Day (15-20)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Half Day (21-30)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Half Day (31-39)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Half Day (40+)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Full Day (15-20)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Full Day (21-30)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Full Day (31-39)": { unit:"per_student", measure:"per student" },
  "University Campus Tour - Full Day (40+)": { unit:"per_student", measure:"per student" },

  "University Campus Tour + Science Lab Visit - Half Day (15-20)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Half Day (21-30)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Half Day (31-39)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Half Day (40+)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Full Day (15-20)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Full Day (21-30)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Full Day (31-39)": { unit:"per_student", measure:"per student" },
  "University Campus Tour + Science Lab Visit - Full Day (40+)": { unit:"per_student", measure:"per student" },

  "Day Tour in Brisbane": { unit:"per_student", measure:"per student" },
  "Local School Immersion": { unit:"per_student", measure:"per student" },
  "Day Tour to Gold Coast with Theme Park Visit": { unit:"per_student", measure:"per student" },

  "Aviation Class": { unit:"group_tiered", measure:"fixed / group (tiered)" },

  "BNE Airport to City, or return - Single Pax": { unit:"per_bus", measure:"per trip" },
  "BNE Airport to City, or return - 10 seat mini bus": { unit:"per_bus", measure:"per trip" },
  "BNE Airport to City, or return - 21/24 seat mini bus": { unit:"per_bus", measure:"per trip" },
  "BNE Airport to City, or return - 39 seat midi coach": { unit:"per_bus", measure:"per trip" },
  "BNE Airport to City, or return - 57 seat coach": { unit:"per_bus", measure:"per trip" },
  "BNE Airport to City, or return - 61 seat coach": { unit:"per_bus", measure:"per trip" },

  "8hr Tour Local - 10 seat mini bus": { unit:"per_bus", measure:"per 8hr trip" },
  "8hr Tour Local - 21/24 seat mini bus": { unit:"per_bus", measure:"per 8hr trip" },
  "8hr Tour Local - 39 seat midi coach": { unit:"per_bus", measure:"per 8hr trip" },
  "8hr Tour Local - 57 seat coach": { unit:"per_bus", measure:"per 8hr trip" },
  "8hr Tour Local - 61 seat coach": { unit:"per_bus", measure:"per 8hr trip" },

  "8hr Tour Over 100km - 10 seat mini bus": { unit:"per_bus", measure:"per 8hr trip (100km+)" },
  "8hr Tour Over 100km - 21/24 seat mini bus": { unit:"per_bus", measure:"per 8hr trip (100km+)" },
  "8hr Tour Over 100km - 39 seat midi coach": { unit:"per_bus", measure:"per 8hr trip (100km+)" },
  "8hr Tour Over 100km - 57 seat coach": { unit:"per_bus", measure:"per 8hr trip (100km+)" },
  "8hr Tour Over 100km - 61 seat coach": { unit:"per_bus", measure:"per 8hr trip (100km+)" },

  "Theme Park Transfers - 10 seat mini bus": { unit:"per_bus", measure:"per transfer" },
  "Theme Park Transfers - 21/24 seat mini bus": { unit:"per_bus", measure:"per transfer" },
  "Theme Park Transfers - 39 seat midi coach": { unit:"per_bus", measure:"per transfer" },
  "Theme Park Transfers - 57 seat coach": { unit:"per_bus", measure:"per transfer" },
  "Theme Park Transfers - 61 seat coach": { unit:"per_bus", measure:"per transfer" },

  "Australia Zoo - 10 seat mini bus": { unit:"per_bus", measure:"per trip" },
  "Australia Zoo - 21/24 seat mini bus": { unit:"per_bus", measure:"per trip" },
  "Australia Zoo - 39 seat midi coach": { unit:"per_bus", measure:"per trip" },
  "Australia Zoo - 57 seat coach": { unit:"per_bus", measure:"per trip" },
  "Australia Zoo - 61 seat coach": { unit:"per_bus", measure:"per trip" }
};

/* Default Prices */
const defaultPrices = {
  "Application Fee": 250,

  "Trainer Cost - Business Days": 0,
  "Trainer Cost - Weekend (20% Levy)": 0,
  "Administrative Cost - Business Days": 0,
  "Administrative Cost - Weekend (20% Levy)": 0,
  "Media Team Cost ‚Äì Business Days": 0,

  "Health Care (Equipment Usage)": 50,
  "Cookery (Cooking Materials)": 15,
  "ELICOS (Printing Material)": 10,
  "First Aid": 80,

  "Placement Fee": 380,
  "Homestay Twin": 400,
  "Homestay Single": 450,
  "Escort Homestay Fee": 400,
  "Dietary Requirements": 10,
  "Pick-up & drop-off service": 125,

  "Full Year 2025 Studio": 299,
  "Semester One 2025 Studio": 329,
  "Semester Two 2025 Studio": 329,
  "Short Stay Studio": 359,

  "University Campus Tour - Half Day (15-20)": 123,
  "University Campus Tour - Half Day (21-30)": 116,
  "University Campus Tour - Half Day (31-39)": 110,
  "University Campus Tour - Half Day (40+)": 104,
  "University Campus Tour - Full Day (15-20)": 180,
  "University Campus Tour - Full Day (21-30)": 171,
  "University Campus Tour - Full Day (31-39)": 162,
  "University Campus Tour - Full Day (40+)": 168,

  "University Campus Tour + Science Lab Visit - Half Day (15-20)": 123,
  "University Campus Tour + Science Lab Visit - Half Day (21-30)": 116,
  "University Campus Tour + Science Lab Visit - Half Day (31-39)": 110,
  "University Campus Tour + Science Lab Visit - Half Day (40+)": 104,
  "University Campus Tour + Science Lab Visit - Full Day (15-20)": 180,
  "University Campus Tour + Science Lab Visit - Full Day (21-30)": 171,
  "University Campus Tour + Science Lab Visit - Full Day (31-39)": 162,
  "University Campus Tour + Science Lab Visit - Full Day (40+)": 168,

  "Day Tour in Brisbane": 0,
  "Local School Immersion": 0,
  "Day Tour to Gold Coast with Theme Park Visit": 0,

  "Aviation Class": 0, /* uses tiers below */

  "BNE Airport to City, or return - Single Pax": 132,
  "BNE Airport to City, or return - 10 seat mini bus": 220,
  "BNE Airport to City, or return - 21/24 seat mini bus": 297,
  "BNE Airport to City, or return - 39 seat midi coach": 341,
  "BNE Airport to City, or return - 57 seat coach": 385,
  "BNE Airport to City, or return - 61 seat coach": 407,

  "8hr Tour Local - 10 seat mini bus": 850,
  "8hr Tour Local - 21/24 seat mini bus": 990,
  "8hr Tour Local - 39 seat midi coach": 1100,
  "8hr Tour Local - 57 seat coach": 1210,
  "8hr Tour Local - 61 seat coach": 1250,

  "8hr Tour Over 100km - 10 seat mini bus": 880,
  "8hr Tour Over 100km - 21/24 seat mini bus": 1100,
  "8hr Tour Over 100km - 39 seat midi coach": 1210,
  "8hr Tour Over 100km - 57 seat coach": 1320,
  "8hr Tour Over 100km - 61 seat coach": 1430,

  "Theme Park Transfers - 10 seat mini bus": 638,
  "Theme Park Transfers - 21/24 seat mini bus": 770,
  "Theme Park Transfers - 39 seat midi coach": 880,
  "Theme Park Transfers - 57 seat coach": 990,
  "Theme Park Transfers - 61 seat coach": 1100,

  "Australia Zoo - 10 seat mini bus": 880,
  "Australia Zoo - 21/24 seat mini bus": 1100,
  "Australia Zoo - 39 seat midi coach": 1210,
  "Australia Zoo - 57 seat coach": 1320,
  "Australia Zoo - 61 seat coach": 1430
};

/* ===== Editable Aviation Tiers =====
   Each row: {min, max, price}
   Last overflow row: {min:36, max:Infinity, base, extraPer, extraStart}
*/
let aviationTiers = [
  { min: 1,  max: 15, price: 4500 },
  { min: 16, max: 20, price: 5200 },
  { min: 21, max: 25, price: 5900 },
  { min: 26, max: 30, price: 6600 },
  { min: 31, max: 35, price: 7300 },
  { min: 36, max: Infinity, base: 7300, extraPer: 230, extraStart: 35 }
];

function aviationPriceByStudents(n){
  n = Math.max(1, Number(n) || 1);
  for (const t of aviationTiers){
    if (t.max !== Infinity && n >= t.min && n <= t.max){
      return Number(t.price) || 0;
    }
  }
  const last = aviationTiers[aviationTiers.length - 1];
  if (last && last.max === Infinity){
    const base = Number(last.base) || 0;
    const extraPer = Number(last.extraPer) || 0;
    const over = Math.max(0, n - (Number(last.extraStart) || 0));
    return base + (over * extraPer);
  }
  return 0;
}

/* ============ Helpers ============ */
const $ = s => document.querySelector(s);
function money(n){ return `$${(Number(n)||0).toFixed(2)}`; }

function makeSelect(options, placeholder="Select"){
  const s=document.createElement('select');
  s.innerHTML = `<option value="">${placeholder}</option>` + options.map(v=>`<option>${v}</option>`).join('');
  return s;
}
function categoryList(){ return Object.keys(catalog); }
function subcategoryList(cat){
  const branch = catalog[cat]; if(!branch) return null;
  const subs = Object.keys(branch);
  return subs.length===1 && subs[0]==="-" ? [] : subs;
}
function itemList(cat, sub){
  const branch = catalog[cat]; if(!branch) return [];
  if (sub && Array.isArray(branch[sub])) return branch[sub];
  if (!sub && branch["-"]) return branch["-"];
  return branch[sub] || [];
}

/* ============ Calculator Row Builder ============ */
function addRow(){
  const tr=document.createElement('tr');
  const tdCat=tr.insertCell(); tdCat.className='cat';
  const tdSub=tr.insertCell(); tdSub.className='sub';
  const tdItem=tr.insertCell(); tdItem.className='item';
  const tdQty=tr.insertCell(); tdQty.className='qty';
  const tdUnit=tr.insertCell(); tdUnit.className='unit';
  const tdMea=tr.insertCell(); tdMea.className='meas';
  const tdTot=tr.insertCell(); tdTot.className='total';
  const tdX=tr.insertCell(); tdX.className='remove';

  // Widgets
  const catSel = makeSelect(categoryList(), "Select Category"); tdCat.appendChild(catSel);
  const subBox = document.createElement('div'); tdSub.appendChild(subBox);
  let itemSel = makeSelect([], "Select Item"); tdItem.appendChild(itemSel);

  const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.value='1'; qty.dataset.override='0'; tdQty.appendChild(qty);
  const unit=document.createElement('input'); unit.type='number'; unit.min='0'; unit.step='0.01'; unit.value='0'; tdUnit.appendChild(unit);
  const meas=document.createElement('div'); meas.textContent='‚Äî'; tdMea.appendChild(meas);
  const totalEl=document.createElement('div'); totalEl.textContent=money(0); tdTot.appendChild(totalEl);
  const del=document.createElement('button'); del.className='xbtn'; del.textContent='√ó'; tdX.appendChild(del);

  del.addEventListener('click', ()=>{ tr.remove(); calculateTotal(); });

  function paintSubcat(cat){
    subBox.innerHTML='';
    const subs = subcategoryList(cat);
    if (!cat) return;
    if (!subs || !subs.length){
      const span=document.createElement('span'); span.textContent='‚Äî'; span.className='muted'; subBox.appendChild(span);
      buildItems(cat, '-'); return;
    }
    const s=makeSelect(subs, "Select Subcategory"); subBox.appendChild(s);
    s.addEventListener('change', ()=> buildItems(catSel.value, s.value));
    buildItems(cat, s.value || '');
  }
  function buildItems(cat, sub){
    const s=document.createElement('select');
    const items=itemList(cat, sub);
    s.innerHTML = `<option value="">Select Item</option>` + items.map(n=>`<option>${n}</option>`).join('');
    itemSel.replaceWith(s); itemSel=s;
    itemSel.addEventListener('change', onItemChange);
    onItemChange();
  }
  function onItemChange(){
    const name=itemSel.value;
    const meta=itemMeta[name]||{};
    meas.textContent = meta.measure || '‚Äî';
    if (defaultPrices[name]!==undefined) unit.value = defaultPrices[name];
    if (qty.dataset.override!=='1') setDefaultQty(name);
    updateRowTotal(tr); calculateTotal();
  }
  function setDefaultQty(name){
    const students = parseInt($('#numStudents').value||'0',10)||0;
    const weeks = Math.max(1, parseInt($('#weeks').value||'1',10)||1);
    const meta = itemMeta[name]||{};
    if (name==="Aviation Class"){ qty.value=1; return; }
    if (meta.cookery){ qty.value=students+1; return; }
    if (meta.unit==="per_bus"){ qty.value=1; return; }
    if (meta.unit==="per_week"){ qty.value=weeks; return; }
    if (meta.unit==="per_hour"){ qty.value=0; return; }
    qty.value = students;
  }

  catSel.addEventListener('change', ()=>{ qty.dataset.override='0'; paintSubcat(catSel.value); updateRowTotal(tr); calculateTotal(); });
  qty.addEventListener('input', ()=>{ qty.dataset.override='1'; updateRowTotal(tr); calculateTotal(); });
  unit.addEventListener('input', ()=>{ updateRowTotal(tr); calculateTotal(); });

  $('#costItems').appendChild(tr);
  return tr;
}

/* ============ Totals & Profit ============ */
const DAYS_PER_WEEK = 5;
// Profit excludes Application Fee, Learning Materials, Accommodation
const profitExclude = new Set(["Application Fee","Learning Materials","Accommodation"]);

function updateRowTotal(tr){
  const item = tr.querySelector('td.item select')?.value || '';
  const qty  = parseFloat(tr.querySelector('td.qty input')?.value || '0') || 0;
  const unit = parseFloat(tr.querySelector('td.unit input')?.value || '0') || 0;

  const students = parseInt($('#numStudents').value||'0',10)||0;
  const weeks = Math.max(1, parseInt($('#weeks').value||'1',10)||1);

  let total = 0;
  const unitType = itemMeta[item]?.unit || '';

  if (item==="Aviation Class"){
    const group = aviationPriceByStudents(students);
    tr.querySelector('td.unit input').value = group.toFixed(2);
    tr.querySelector('td.qty input').value = 1;
    total = group;
  } else {
    let q = qty;
    switch(unitType){
      case 'per_student':       break; // qty = students or manual
      case 'per_student_once':  break; // once
      case 'per_student_week':  q = qty * weeks; break;
      case 'per_student_day':   q = qty * (weeks * DAYS_PER_WEEK); break;
      case 'per_week':          q = qty; break;
      case 'per_hour':          q = qty; break;
      case 'per_bus':           q = qty; break;
      default:                  q = qty;
    }
    total = q * unit;
  }
  tr.querySelector('td.total').textContent = money(total);
  return total;
}

function calculateTotal(){
  let base = 0, profitBase = 0;
  document.querySelectorAll('#costItems tr').forEach(tr=>{
    const cat = tr.querySelector('td.cat select')?.value || '';
    const t = updateRowTotal(tr);
    base += t;
    if (!profitExclude.has(cat)) profitBase += t;
  });

  const pm = parseFloat(document.getElementById('profitMargin').value || '0') || 0;
  const profit = profitBase * (pm / 100);
  const final = base + profit;

  const studs = Math.max(1, parseInt(document.getElementById('numStudents').value || '0', 10) || 1);

  // ‚úÖ COMMISSION DEDUCT MODE
  // Commission add-on (student pays higher price)
const ac = parseFloat(document.getElementById('agentCommission')?.value || '0') || 0;
const finalAfterCommission = final * (1 + ac / 100);  // ‚úÖ add-on, not deduct


  document.getElementById('baseVal').textContent   = money(base);
  document.getElementById('profitVal').textContent = money(profit);
  document.getElementById('finalVal').textContent  = money(final);
  document.getElementById('ppsVal').textContent    = money(final / studs);
  document.getElementById('ppsCommVal').textContent = money(finalAfterCommission / studs);
}


/* Re-sync defaulted qty when globals change (not manual overrides) */
function syncAutoQtyRows(){
  const students = parseInt($('#numStudents').value||'0',10)||0;
  const weeks = Math.max(1, parseInt($('#weeks').value||'1',10)||1);
  document.querySelectorAll('#costItems tr').forEach(tr=>{
    const item = tr.querySelector('td.item select')?.value || '';
    const meta = itemMeta[item]||{};
    const qtyEl = tr.querySelector('td.qty input');
    if (!qtyEl || qtyEl.dataset.override==='1') return;
    if (item==="Aviation Class") qtyEl.value=1;
    else if (meta.cookery) qtyEl.value=students+1;
    else if (meta.unit==="per_bus") qtyEl.value=1;
    else if (meta.unit==="per_week") qtyEl.value=weeks;
    else if (meta.unit==="per_hour") qtyEl.value=0;
    else qtyEl.value=students;
  });
}

/* CSV export */
function exportCSV() {
  const lines = [];

  // Header info
  const id = (document.getElementById("studentGroupName").value || "").trim();
  lines.push(["Student Group Name", id]);
  lines.push(["Student Group", (document.getElementById("studentGroup").value || "").trim()]);
  lines.push(["Number of Students", document.getElementById("numStudents").value || ""]);
  lines.push(["Weeks", document.getElementById("weeks").value || ""]);
  lines.push(["Profit Margin (%)", document.getElementById("profitMargin").value || ""]);
  lines.push(["Agent Commission (%)", document.getElementById("agentCommission").value || ""]); // ‚úÖ new line
  lines.push(["Notes", (document.getElementById("notes").value || "").trim()]); // ‚úÖ new line
  lines.push([]); // spacer
  lines.push(["Category", "Subcategory", "Item", "Qty", "Unit $", "Measure", "Total $"]);

  // Table rows
  document.querySelectorAll("#costItems tr").forEach(tr => {
    const cat = tr.querySelector("td.cat select")?.value || "";
    const sub = tr.querySelector("td.sub select")?.value || "";
    const item = tr.querySelector("td.item select")?.value || "";
    const qty = tr.querySelector("td.qty input")?.value || "";
    const unit = tr.querySelector("td.unit input")?.value || "";
    const meas = tr.querySelector("td.meas")?.textContent.trim() || "";
    const total = tr.querySelector("td.total")?.textContent.replace(/[^\d.-]/g, "") || "0";
    lines.push([cat, sub, item, qty, unit, meas, total]);
  });

  // Summary section
  lines.push([]);
  lines.push(["Base", "", "", "", "", "", document.getElementById("baseVal").textContent]);
  lines.push(["Profit", "", "", "", "", "", document.getElementById("profitVal").textContent]);
  lines.push(["Final", "", "", "", "", "", document.getElementById("finalVal").textContent]);
  lines.push(["Price / Student", "", "", "", "", "", document.getElementById("ppsVal").textContent]);
  lines.push(["Price / Student (commission included)", "", "", "", "", "", document.getElementById("ppsCommVal").textContent]); // ‚úÖ new line

  // Generate CSV
  const csv = lines.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "study_tour_cost_table.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}


/* =========================
   PRICING MANAGER (auto-save + JSON I/O)
========================= */
const MEASURE_OPTIONS = [
  {val:'per_student', label:'per student'},
  {val:'per_student_once', label:'per student (once)'},
  {val:'per_student_week', label:'per student / week'},
  {val:'per_student_day', label:'per student / day'},
  {val:'per_bus', label:'per bus / trip'},
  {val:'per_week', label:'per week'},
  {val:'per_hour', label:'per hour'},
  {val:'group_tiered', label:'fixed / group (tiered)'}
];

function showToast(msg="‚úî Pricing updated"){
  const t = $('#toast'); t.textContent = msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600);
}

function buildPricingRows(){
  const tbody = $('#pmTable tbody'); tbody.innerHTML='';
  const filterCat = $('#pmCategoryFilter').value || '';
  const q = ($('#pmSearch').value||'').toLowerCase();

  Object.keys(catalog).forEach(cat=>{
    if (filterCat && cat!==filterCat) return;
    const subcats = catalog[cat];
    Object.keys(subcats).forEach(sub=>{
      const items = subcats[sub];
      items.forEach(item=>{
        if (q && !(`${cat} ${sub} ${item}`.toLowerCase().includes(q))) return;

        const tr = document.createElement('tr');
        const tdCat = document.createElement('td'); tdCat.textContent = cat;
        const tdSub = document.createElement('td'); tdSub.textContent = (sub==='-'?'‚Äî':sub);
        const tdItem= document.createElement('td'); tdItem.textContent = item;

        const tdPrice = document.createElement('td');
        const inp = document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.min='0';
        inp.value = defaultPrices[item]!==undefined ? defaultPrices[item] : 0;
        tdPrice.appendChild(inp);

        const tdMeas = document.createElement('td');
        const sel = document.createElement('select');
        MEASURE_OPTIONS.forEach(opt=>{
          const o = document.createElement('option'); o.value=opt.val; o.textContent=opt.label;
          sel.appendChild(o);
        });
        const currentUnit = itemMeta[item]?.unit || 'per_student';
        sel.value = currentUnit;
        if (item === "Aviation Class"){ sel.disabled = true; }

        inp.addEventListener('input', ()=>{
          const v = parseFloat(inp.value||'0')||0;
          defaultPrices[item] = v;
          showToast();
        });
        sel.addEventListener('change', ()=>{
          const m = sel.value;
          if (!itemMeta[item]) itemMeta[item] = { unit:m, measure:'' };
          itemMeta[item].unit = m;
          const label = MEASURE_OPTIONS.find(o=>o.val===m)?.label || '‚Äî';
          itemMeta[item].measure = label;
          showToast();
        });

        tr.append(tdCat, tdSub, tdItem, tdPrice, tdMeas);
        tdMeas.appendChild(sel);
        tbody.appendChild(tr);
      });
    });
  });
}

function populateCategoryFilter(){
  const sel = $('#pmCategoryFilter');
  sel.innerHTML = `<option value="">All Categories</option>` + Object.keys(catalog).map(c=>`<option>${c}</option>`).join('');
}

/* Export current pricing JSON (now includes aviationTiers) */
function exportPricingJSON(){
  const payload = {
    version: "jacky-8.6",
    catalog,               // ‚Üê include the latest category/subcategory ‚Üí items
    defaultPrices,
    itemMeta,
    aviationTiers
  };
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  a.download = 'pricing_backup.json';
  document.body.appendChild(a); a.click(); a.remove();
}


/* Import pricing JSON */
function importPricingJSON(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);

      // 2a) Bring in catalog (full replace by mutation)
      if (data.catalog && typeof data.catalog === 'object'){
        // wipe current keys
        Object.keys(catalog).forEach(k => delete catalog[k]);
        // copy new keys
        Object.assign(catalog, data.catalog);
      }

      // 2b) Prices
      if (data.defaultPrices && typeof data.defaultPrices==='object'){
        Object.assign(defaultPrices, data.defaultPrices);
      }

      // 2c) Measurements
      if (data.itemMeta && typeof data.itemMeta==='object'){
        Object.keys(data.itemMeta).forEach(k=>{
          if (!itemMeta[k]) itemMeta[k]={};
          Object.assign(itemMeta[k], data.itemMeta[k]);
        });
      }

      // 2d) Aviation tiers
      if (Array.isArray(data.aviationTiers) && data.aviationTiers.length){
        aviationTiers = data.aviationTiers;
      }

      // 2e) Refresh UI with new catalog & data
      populateCategoryFilter();
      buildPricingRows();
      document.querySelectorAll('#costItems tr').forEach(updateRowTotal);
      calculateTotal();
      showToast("‚úî Pricing imported");
    }catch(err){
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
}


/* ===== Add New Item Modal ===== */
const addModalBg = document.getElementById('addModalBg');
const addCat = document.getElementById('addCat');
const addSub = document.getElementById('addSub');
const addName = document.getElementById('addName');
const addPrice = document.getElementById('addPrice');
const addMeasure = document.getElementById('addMeasure');
const addError = document.getElementById('addError');

function openAddModal(){
  addCat.innerHTML = Object.keys(catalog).map(c=>`<option>${c}</option>`).join('');
  addMeasure.innerHTML = MEASURE_OPTIONS.map(o=>`<option value="${o.val}">${o.label}</option>`).join('');
  addMeasure.value = 'per_student';

  addName.value=''; addPrice.value='0';
  addError.style.display='none';
  rebuildAddSub();

  addModalBg.style.display='flex';
  addModalBg.setAttribute('aria-hidden','false');
}
function closeAddModal(){
  addModalBg.style.display='none';
  addModalBg.setAttribute('aria-hidden','true');
}
function rebuildAddSub(){
  const cat = addCat.value;
  const subs = subcategoryList(cat) || [];
  if (!subs.length){
    addSub.innerHTML = `<option value="-" selected>‚Äî</option>`;
    addSub.disabled = true;
  }else{
    addSub.disabled = false;
    addSub.innerHTML = `<option value="">Select Subcategory</option>` + subs.map(s=>`<option>${s}</option>`).join('');
  }
}
function addNewItem(){
  const cat = addCat.value;
  let sub = addSub.disabled ? '-' : (addSub.value || '');
  const name = (addName.value||'').trim();
  const price = parseFloat(addPrice.value||'0')||0;
  const measure = addMeasure.value;

  if (!cat){ return showAddError("Please choose a category."); }
  if (!sub){ return showAddError("Please choose a subcategory."); }
  if (!name){ return showAddError("Please enter an item name."); }

  const currentList = (catalog[cat] && catalog[cat][sub]) ? catalog[cat][sub] : [];
  if (currentList.includes(name)){
    return showAddError("Item already exists in this category/subcategory.");
  }

  if (!catalog[cat][sub]) catalog[cat][sub] = [];
  catalog[cat][sub].push(name);

  defaultPrices[name] = price;
  const label = (MEASURE_OPTIONS.find(o=>o.val===measure)?.label)||'‚Äî';
  itemMeta[name] = { unit: measure, measure: label };

  buildPricingRows();
populateCategoryFilter();
showToast("‚úî Item added");
closeAddModal();

}

function showAddError(msg){
  addError.textContent = msg;
  addError.style.display='block';
}

/* ===== Aviation Tiers Modal ===== */
const aviModalBg = document.getElementById('aviModalBg');
const aviTierBody = document.getElementById('aviTierBody');
const aviBase = document.getElementById('aviBase');
const aviExtraPer = document.getElementById('aviExtraPer');
const aviExtraStart = document.getElementById('aviExtraStart');
const aviErr = document.getElementById('aviErr');

function openAviModal(){
  aviTierBody.innerHTML = '';
  const fixed = aviationTiers.filter(t=>t.max !== Infinity);
  fixed.forEach((t, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="number" min="1" step="1" value="${t.min}"></td>
      <td><input type="number" min="1" step="1" value="${t.max}"></td>
      <td><input type="number" min="0" step="1" value="${t.price}"></td>
    `;
    aviTierBody.appendChild(tr);
  });

  const last = aviationTiers[aviationTiers.length-1] || {};
  aviBase.value = last.base ?? 7300;
  aviExtraPer.value = last.extraPer ?? 230;
  aviExtraStart.value = last.extraStart ?? 35;

  aviErr.style.display='none';
  aviModalBg.style.display='flex';
  aviModalBg.setAttribute('aria-hidden','false');
}
function closeAviModal(){
  aviModalBg.style.display='none';
  aviModalBg.setAttribute('aria-hidden','true');
}
function saveAviationTiers(){
  const rows = [...aviTierBody.querySelectorAll('tr')];
  const bands = rows.map(r=>{
    const [minEl, maxEl, priceEl] = r.querySelectorAll('input');
    return {
      min: Number(minEl.value||0),
      max: Number(maxEl.value||0),
      price: Number(priceEl.value||0)
    };
  }).sort((a,b)=>a.min-b.min);

  for (let i=0;i<bands.length;i++){
    const b = bands[i];
    if (!(b.min>=1 && b.max>=b.min && b.price>=0)){
      return showAviError("Please ensure min/max/price are valid numbers (max ‚â• min, price ‚â• 0).");
    }
    if (i>0 && b.min <= bands[i-1].max){
      return showAviError("Tiers overlap. Each tier's min must be greater than the previous tier's max.");
    }
  }

  const base = Number(aviBase.value||0);
  const extraPer = Number(aviExtraPer.value||0);
  const extraStart = Number(aviExtraStart.value||0);
  if (base<0 || extraPer<0 || extraStart<0){
    return showAviError("Overflow values must be ‚â• 0.");
  }

  aviationTiers = [
    ...bands,
    { min: (bands[bands.length-1]?.max||35)+1, max: Infinity, base, extraPer, extraStart }
  ];

  closeAviModal();
  showToast("‚úî Aviation tiers updated");
  document.querySelectorAll('#costItems tr').forEach(updateRowTotal);
  calculateTotal();
}
function showAviError(msg){
  aviErr.textContent = msg;
  aviErr.style.display='block';
}

/* ===== View Navigation ===== */
function showPricingManager(){
  $('#calculatorView').style.display='none';
  $('#pricingManagerView').style.display='block';
  $('#toPricing').style.display='none';
  $('#toCalc').style.display='inline-block';
  populateCategoryFilter();
  buildPricingRows();
}
function showCalculator(){
  $('#pricingManagerView').style.display='none';
  $('#calculatorView').style.display='block';
  $('#toPricing').style.display='inline-block';
  $('#toCalc').style.display='none';
}

/* ===== Wire-up ===== */
document.getElementById('addRowBtn').addEventListener('click', ()=> addRow());
document.getElementById('csvBtn').addEventListener('click', exportCSV);

['numStudents','weeks','profitMargin','agentCommission'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    syncAutoQtyRows();
    calculateTotal();
  });
});

// top buttons
document.getElementById('toPricing').addEventListener('click', showPricingManager);
document.getElementById('toCalc').addEventListener('click', showCalculator);
document.getElementById('toCalcBottom').addEventListener('click', showCalculator);

// Pricing Manager events
document.getElementById('pmCategoryFilter').addEventListener('change', buildPricingRows);
document.getElementById('pmSearch').addEventListener('input', buildPricingRows);
document.getElementById('pmExport').addEventListener('click', exportPricingJSON);
document.getElementById('pmImport').addEventListener('change', (e)=>{
  if (e.target.files && e.target.files[0]) importPricingJSON(e.target.files[0]);
});
document.getElementById('pmAddBtn').addEventListener('click', openAddModal);

// Add Item modal events
document.getElementById('addClose').addEventListener('click', closeAddModal);
document.getElementById('addCancel').addEventListener('click', closeAddModal);
addCat.addEventListener('change', rebuildAddSub);
document.getElementById('addSave').addEventListener('click', addNewItem);

// Aviation modal events
document.getElementById('pmAviBtn').addEventListener('click', openAviModal);
document.getElementById('aviClose').addEventListener('click', closeAviModal);
document.getElementById('aviCancel').addEventListener('click', closeAviModal);
document.getElementById('aviSave').addEventListener('click', saveAviationTiers);

// Init
calculateTotal();
</script>
